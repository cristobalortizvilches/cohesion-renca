---
title: "Gráficos Presentación Renca"
author: "Cristóbal Ortiz"
date: "2023-07-14"
output:
  html_document: 
     keep_md: yes
     theme: paper
     highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "left",
	fig.topcaption = TRUE,
	message = FALSE,
	warning = FALSE,
	cache = FALSE
)
Sys.setlocale("LC_ALL","ES_ES.UTF-8")
```

```{r packages, message=FALSE, warning=FALSE, include=FALSE}
library(poLCA)
library(knitr)
library(kableExtra)
library(gridExtra)
library(tidyverse)
library(sjmisc)
library(sjlabelled)
library(ggrepel)
library(ggalluvial)
library(haven)
library(sp)
library(viridis)
```

```{r datos, include=FALSE}
remove(list = ls())
getwd()
#renca <- read_dta("../1_input/data/Renca_1010_macrozona.dta")

load("../1_input/data/procesada/renca_macrozona.RData")
load("../1_input/data/procesada/renca_macrozona_prom.RData")

load("../1_input/data/procesada/renca_civic_lca.RData")
load("../1_input/data/procesada/renca_confaut_lca.RData")

renca_confaut_lca <- renca_confaut_lca %>% 
  left_join(renca_macrozona, by = 'respondent_id')

renca_civic_lca <- renca_civic_lca %>% 
  left_join(renca_macrozona, by = 'respondent_id')

fuente <- "Fuente: elaboración propia en base a los datos del Estudios de Percepcíon y Evaluación Comunal de Renca 2023"
```

# 1. Caracterización de macrozonas y población 

## Macrozonas

```{r educ-zona}
renca_macrozona %>%
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(educ, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(cod_mz), fill = fct_rev(educ), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Nivel educacional según macrozona')
```

```{r ingr-zona}
renca_macrozona %>%
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(ingr, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(cod_mz), fill = fct_rev(ingr), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Nivel de ingresos según macrozona')
```


# 2. La cohesión social barrial en Renca
## 2.1. Pertenencia barrial

```{r spbi-sexo}
spbi_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(spbf, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = spbf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de pertenencia al barrio según sexo/género",
       x = "", y = "", fill = "Nivel de pertencia al barrio",
       caption = fuente) +
  theme(legend.position = "top")
spbi_sexo
```

```{r spbi-edad}
spbi_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(spbf, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!edad == "Otro (especifique)",
         !spbf == "Medio") %>% 
  ggplot(aes(x = edad, y = freq, fill = spbf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de pertenencia al barrio según grupo etario",
       x = "", y = "", fill = "Nivel de pertencia al barrio",
       caption = fuente) +
  theme(legend.position = "top")
spbi_edad
```

```{r spbi-nse}

```

```{r spbi-mcz}
spbi_mcz <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(spbf, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = spbf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de pertenencia al barrio según macrozona",
       x = "Macrozona", y = "", fill = "Nivel de pertencia al barrio",
       caption = fuente) +
  theme(legend.position = "top")
spbi_mcz
```

```{r spbi-mcz-segu}
spbi_segu <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  ggplot(aes(x = cod_mz, y = spbi, fill = segu)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(renca_macrozona$spbi, na.rm = T), color = 'red') +
  geom_text(aes(0, mean(renca_macrozona$spbi, na.rm = T), label = "x̅ = 3.3", vjust = -1, hjust =-0.2), size = 3) +
    labs(x = "Macrozona", 
         y = "Pertenencia barrial",
         fill = "Nivel de seguridad barrial") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 12)) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D")
spbi_segu
```

```{r spbi-mcz-repb}
spbi_repb <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  ggplot(aes(x = cod_mz, y = spbi, fill = repb)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(renca_macrozona$spbi, na.rm = T), color = 'red') +
  geom_text(aes(0, mean(renca_macrozona$spbi, na.rm = T), label = "x̅ = 3.3", vjust = -1, hjust =-0.2), 
            size = 3) +
    labs(x = "Macrozona", 
         y = "Pertenencia barrial",
         fill = "Reputación barrial") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 12)) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D")
spbi_repb
```

```{r spbi-map}
renca_macrozona_prom <- st_read("../1_input/shapes/renca_macrozona_prom.shp") %>% 
  st_transform(24879)

plot_spbi <- renca_macrozona_prom %>% 
  ggplot(aes(fill = spbi, geometry = geometry), color = ) + 
  geom_sf() +
  geom_sf_text(aes(label = MACROZONA), size = 2) +
  scale_fill_viridis_c(direction = -1) +
  theme() +
  labs(title = "Pertenencia barrial según Macrozonas de Renca",
       fill = "Nivel de pertenencia barrial\n(promedio macrozona)",
       x = "", y = "")
plot_spbi
```

## 2.2. Arraigo físico

```{r arra-sexo}
arra_sexo <- renca_macrozona %>% 
  as_label(arra, sexo) %>% 
  drop_na() %>% 
  count(arra, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = arra, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Arraigo físico según sexo/género",
       x = "Macrozona", y = "", fill = "¿Tiene planeado cambiarse de\nvivienda en el próximo año?",
       caption = fuente)
arra_sexo
```

```{r arra-edad}
arra_edad <- renca_macrozona %>% 
  as_label(arra, edad) %>% 
  drop_na() %>% 
  count(arra, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!edad == "Otro (especifique)") %>% 
  ggplot(aes(x = edad, y = freq, fill = arra, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Arraigo físico según grupo etario",
       x = "Macrozona", y = "", fill = "¿Tiene planeado cambiarse de\nvivienda en el próximo año?",
       caption = fuente)
arra_edad
```

```{r arra-nse}

```

```{r arra-mcz}
arra_mcz <- renca_macrozona %>% 
  as_label(arra, cod_mz) %>% 
  drop_na() %>% 
  count(arra, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = arra, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Arraigo físico según macrozona",
       x = "Macrozona", y = "", fill = "¿Tiene planeado cambiarse de\nvivienda en el próximo año?",
       caption = fuente)
arra_mcz
```

```{r arra-segu}
arra_segu <- renca_macrozona %>% 
  as_label(arra, segu) %>% 
  drop_na() %>% 
  count(arra, segu) %>% 
  group_by(segu) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = segu, y = freq, fill = arra, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Arraigo físico según nivel de seguridad",
       x = "Nivel de seguridad", y = "", 
       fill = "¿Tiene planeado cambiarse de\nvivienda en el próximo año?",
       caption = fuente)
arra_segu
```

```{r arra-repb}
arra_repb <- renca_macrozona %>% 
  as_label(arra, repb) %>% 
  drop_na() %>% 
  count(arra, repb) %>% 
  group_by(repb) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = repb, y = freq, fill = arra, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Arraigo físico según reputación barrial",
       x = "Reputación barrial", y = "", 
       fill = "¿Tiene planeado cambiarse de\nvivienda en el próximo año?",
       caption = fuente)
arra_repb
```

## 2.3. Sociabilidad barrial

```{r soci-sexo}
soci_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(socif, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = socif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de sociabilidad barrial según sexo/género",
       x = "", y = "", fill = "Nivel de sociabilidad barrial",
       caption = fuente) +
  theme(legend.position = "top")
soci_sexo
```

```{r soci-edad}
soci_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(socif, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!edad == "Otro (especifique)") %>% 
  ggplot(aes(x = edad, y = freq, fill = socif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de sociabilidad barrial según grupo etario",
       x = "", y = "", fill = "Nivel de sociabilidad barrial",
       caption = fuente) +
  theme(legend.position = "top")
soci_edad
```

```{r soci-nse}

```

```{r soci-mcz}
soci_mcz <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  count(socif, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = socif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de sociabilidad barrial según macrozona",
       x = "Macrozona", y = "", fill = "Nivel de sociabilidad barrial",
       caption = fuente) +
  theme(legend.position = "top")
soci_mcz
```

```{r soci-mcz-segu}
soci_segu <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  ggplot(aes(x = cod_mz, y = soci, fill = segu)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(renca_macrozona$soci, na.rm = T), color = 'red') +
  geom_text(aes(0, mean(renca_macrozona$soci, na.rm = T), label = "x̅ = 3.4", vjust = -1, hjust =-0.2), size = 3) +
    labs(x = "Macrozona", 
         y = "Sociabilidad barrial",
         fill = "Nivel de seguridad barrial") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 12)) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D")
soci_segu
```

```{r soci-mcz-repb}
soci_repb <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  ggplot(aes(x = cod_mz, y = soci, fill = repb)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(renca_macrozona$soci, na.rm = T), color = 'red') +
  geom_text(aes(0, mean(renca_macrozona$soci, na.rm = T), label = "x̅ = 3.4", vjust = -1, hjust =-0.2), 
            size = 3) +
    labs(x = "Macrozona", 
         y = "Sociabilidad barrial",
         fill = "Reputación barrial") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(size = 12)) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D")
soci_repb
```

```{r soci-map}
plot_soci <- renca_macrozona_prom %>% 
  ggplot(aes(fill = soci, geometry = geometry), color = ) + 
  geom_sf() +
  geom_sf_text(aes(label = cod_mz), size = 3) +
  scale_fill_viridis_c(direction = -1) +
  theme() +
  labs(title = "Sociabilidad barrial según Macrozonas de Renca",
       fill = "Nivel de sociabilidad barrial\n(promedio macrozona)",
       x = "", y = "")
plot_soci
```

## 2.4. Confianza en vecinos

```{r confif-sexo}
confif_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(confif, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = confif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza vecinal según sexo/género",
       x = "", y = "", fill = "Nivel de confianza vecinal",
       caption = fuente) +
  theme(legend.position = "top")
confif_sexo
```

```{r confif-edad}
confif_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(confif, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!edad == "Otro (especifique)") %>% 
  ggplot(aes(x = edad, y = freq, fill = confif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza vecinal según grupo etario",
       x = "", y = "", fill = "Nivel de confianza vecinal",
       caption = fuente) +
  theme(legend.position = "top")
confif_edad
```

```{r confif-nse}

```

```{r confif-mcz}
confif_mcz <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  count(confif, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  drop_na() %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = confif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza vecinal según macrozona",
       x = "Macrozona", y = "", fill = "Nivel de confianza vecinal",
       caption = fuente) +
  theme(legend.position = "top")
confif_mcz
```

```{r confif-map}
plot_confi <- renca_macrozona_prom %>% 
  ggplot(aes(fill = confi, geometry = geometry), color = ) + 
  geom_sf() +
  geom_sf_text(aes(label = cod_mz), size = 3) +
  scale_fill_viridis_c(direction = -1) +
  theme() +
  labs(title = "Confianza vecinal según Macrozonas de Renca",
       fill = "Nivel de confianza vecinal\n(promedio macrozona)",
       x = "", y = "")
plot_confi
```

```{r confif-segu}
confif_segu <- renca_macrozona %>% 
  as_label(confif, segu) %>% 
  drop_na() %>% 
  count(confif, segu) %>% 
  group_by(segu) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = segu, y = freq, fill = confif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza vecinal según nivel de seguridad",
       x = "Nivel de seguridad", y = "", 
       fill = "Nivel de confianza",
       caption = fuente)
confif_segu
```

```{r confif-repb}
confif_repb <- renca_macrozona %>% 
  as_label(confif, repb) %>% 
  drop_na() %>% 
  count(confif, repb) %>% 
  group_by(repb) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = repb, y = freq, fill = confif, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza vecinal según reputación barrial",
       x = "Reputación barrial", y = "", 
       fill = "Nivel de confianza",
       caption = fuente)
confif_repb
```

## 2.5. Apoyo vecinal

```{r apoy-sexo}
apoy_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(apoy, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = apoy, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Apoyo social según sexo/género",
       x = "", y = "", fill = "Cantidad de visitas a vecinos",
       caption = fuente) +
  theme(legend.position = "top")
apoy_sexo
```

```{r apoy-edad}
apoy_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(apoy, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!edad == "Otro (especifique)") %>% 
  ggplot(aes(x = edad, y = freq, fill = apoy, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Apoyo social según grupo etario",
       x = "", y = "", fill = "Cantidad de visitas a vecinos",
       caption = fuente) +
  theme(legend.position = "top")
apoy_edad
```

```{r apoy-nse}

```

```{r apoy-mcz}
apoy_mcz <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  count(apoy, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  drop_na() %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = apoy, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Apoyo social según macrozona",
       x = "Macrozona", y = "", fill = "Cantidad de visitas a vecinos",
       caption = fuente) +
  theme(legend.position = "top")
apoy_mcz
```

```{r apoy-segu}
apoy_segu <- renca_macrozona %>% 
  as_label(apoy, segu) %>% 
  drop_na() %>% 
  count(apoy, segu) %>% 
  group_by(segu) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = segu, y = freq, fill = apoy, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Apoyo social según nivel de seguridad",
       x = "Nivel de seguridad", y = "", 
       fill = "Cantidad de visitas a vecinos",
       caption = fuente)
apoy_segu
```

```{r apoy-repb}
apoy_repb <- renca_macrozona %>% 
  as_label(apoy, repb) %>% 
  drop_na() %>% 
  count(apoy, repb) %>% 
  group_by(repb) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = repb, y = freq, fill = apoy, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(0.5), vjust = 0.3, size = 2.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Apoyo social según reputación barrial",
       x = "Reputación barrial", y = "", 
       fill = "Cantidad de visitas a vecinos",
       caption = fuente)
apoy_repb
```

## 2.6. Perfiles de cohesión barrial en Renca (Pendiente)

```{r tipos-cb}
tab_4 %>% ggplot(aes(x = freq, y = factor(var, levels = c("Apoyo","Participación", "Confianza","Sociabilidad", "Arraigo", "Pertenencia")),  fill = Tipos)) + 
  geom_bar(stat = 'identity', position = 'stack') +
  labs(y = NULL, x = NULL,
       title = "Perfiles de cohesión barrial", fill = "") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits=c(0, 1)) +
  
  scale_fill_viridis_d(end = .85, option = 'viridis') +
  theme(axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  facet_grid(~ Clase) +
  guides(fill = guide_legend(reverse = TRUE))
```

```{r tipos-sexo}
renca_macrozona %>%
  filter(!sexo == "Otro (especifique)") %>% 
  count(class_4, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(sexo), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según sexo')

```

```{r tipos-educ}
renca_macrozona %>%
  count(class_4, educ) %>% 
  group_by(educ) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(educ), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según nivel educacional')
```

```{r tipos-ingr}
renca_macrozona %>%
  count(class_4, ingr) %>% 
  group_by(ingr) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(ingr), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según nivel de ingresos')
```

```{r tipos-zonas}
renca_macrozona %>%
  as_label(cod_mz) %>% 
  count(class_4, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(cod_mz), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según macrozona')
```

```{r tipos-repb}
renca_macrozona %>%
  as_label(repb) %>% 
  count(class_4, repb) %>% 
  group_by(repb) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(repb), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según reputación barrial')
```

```{r tipos-segu}
renca_macrozona %>%
  as_label(segu) %>% 
  count(class_4, segu) %>% 
  group_by(segu) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(segu), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según sentimiento de seguridad en el barrio')
```

```{r tipos-edad}
renca_macrozona %>%
  as_label(edad) %>% 
  count(class_4, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(edad), fill = fct_rev(class_4), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de cohesión barrial según tramo etario')
```


#3. La cohesión social vertical
## 3.1.a Confianza en autoridades e instituciones comunales (índice)
```{r confaf-sexo}
confaf_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(confaf, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = confaf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza en autoridades comunales según sexo/género",
       x = "", y = "", fill = "Nivel de confianza",
       caption = fuente) +
  theme(legend.position = "top")
confaf_sexo
```

```{r confaf-edad}
confaf_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(confaf, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = edad, y = freq, fill = confaf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza en autoridades comunales según grupo etario",
       x = "", y = "", fill = "Nivel de confianza",
       caption = fuente) +
  theme(legend.position = "top")
confaf_edad
```

```{r confaf-nse}

```

```{r confaf-mcz}
confaf_mcz <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(confaf, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = confaf, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(0.9), vjust = -0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Confianza en autoridades comunales según grupo macrozna",
       x = "Macrozona", y = "", fill = "Nivel de confianza",
       caption = fuente) +
  theme(legend.position = "top")
confaf_mcz
```

```{r confaf-map}
plot_confaf <- renca_macrozona_prom %>% 
  ggplot(aes(fill = confa, geometry = geometry), color = ) + 
  geom_sf() +
  geom_sf_text(aes(label = MACROZONA), size = 2) +
  scale_fill_viridis_c(direction = -1) +
  theme() +
  labs(title = "Confianza en autoridades comunales según grupo macrozna",
       x = "", y = "", fill = "Nivel de confianza")
plot_confaf
```

## 3.1.b Confianza en autoridades e instituciones comunales (perfiles)
```{r confaut-sexo}
renca_confaut_lca %>%
  filter(!sexo == "Otro (especifique)") %>% 
  count(clase_3_label, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(sexo), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'erfiles de confianza institucional según sexo')
```

```{r confaut-edad}
renca_confaut_lca %>%
  count(clase_3_label, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  drop_na() %>% 
  ggplot(aes(x = freq, y = fct_rev(edad), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de confianza institucional según edad')
```

```{r confaut-mcz}
renca_confaut_lca %>%
  as_label(cod_mz) %>% 
  count(clase_3_label, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(cod_mz), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de confianza institucional según macrozona')
```

## 3.2. Participación cívica
```{r civic-sexo}
renca_civic_lca %>%
  filter(!sexo == "Otro (especifique)") %>% 
  count(clase_3_label, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(sexo), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de participación cívica según sexo')
```

```{r civic-edad}
renca_civic_lca %>%
  count(clase_3_label, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  drop_na() %>% 
  ggplot(aes(x = freq, y = fct_rev(edad), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de participación cívica según edad')
```

```{r civic-mcz}
renca_civic_lca %>%
  as_label(cod_mz) %>% 
  count(clase_3_label, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = freq, y = fct_rev(cod_mz), fill = fct_rev(clase_3_label), 
             label = scales::percent(ifelse(freq < .01, NA, freq), .1))) + 
  geom_bar(stat = 'identity', position = 'stack') +
  scale_x_continuous(labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_text(position = position_stack(vjust = .5), 
            size = 3, na.rm = TRUE,) +
  theme_bw() + 
  scale_fill_viridis_d(end = .85, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) +
  labs(y = NULL, x = NULL, fill = NULL,
       title = 'Perfiles de participación cívica según macrozona')
```

# 4. Evaluación del municipio y la comuna

## 4.1. Gestión e infraestructura municipal

```{r eval1-sexo}
eval1_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(eval1f, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = eval1f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de gestión e infraestructura municipal según sexo/género",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente) 
eval1_sexo
```

```{r eval1-edad}
eval1_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(eval1f, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = edad, y = freq, fill = eval1f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de gestión e infraestructura municipal según edad",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval1_edad
```

```{r eval1-mcz}
eval1_edad <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(eval1f, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = eval1f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de gestión e infraestructura municipal según macrozona",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval1_edad
```

## 4.2. Programas y servicios municipales

```{r eval2-sexo}
eval2_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(eval2f, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = eval2f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de programas y servicios municipales según sexo/género",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente) 
eval2_sexo
```

```{r eval2-edad}
eval2_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(eval2f, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = edad, y = freq, fill = eval2f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de programas y servicios municipales según edad",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval2_edad
```

```{r eval2-mcz}
eval2_edad <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(eval2f, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = eval2f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de programas y servicios municipales según macrozona",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval2_edad
```


## 4.3. Infraestrutura y equipamiento barrial
```{r eval3-sexo}
eval3_sexo <- renca_macrozona %>% 
  as_label(sexo) %>% 
  drop_na() %>% 
  count(eval3f, sexo) %>% 
  group_by(sexo) %>% 
  mutate(freq = (n/sum(n))) %>% 
  filter(!sexo == "Otro (especifique)") %>% 
  ggplot(aes(x = sexo, y = freq, fill = eval3f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de insfraestructura y equipamiento barrial según sexo/género",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente) 
eval3_sexo
```

```{r eval3-edad}
eval3_edad <- renca_macrozona %>% 
  as_label(edad) %>% 
  drop_na() %>% 
  count(eval3f, edad) %>% 
  group_by(edad) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = edad, y = freq, fill = eval3f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de insfraestructura y equipamiento barrial según edad",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval3_edad
```

```{r eval3-mcz}
eval3_edad <- renca_macrozona %>% 
  as_label(cod_mz) %>% 
  drop_na() %>% 
  count(eval3f, cod_mz) %>% 
  group_by(cod_mz) %>% 
  mutate(freq = (n/sum(n))) %>% 
  ggplot(aes(x = cod_mz, y = freq, fill = eval3f, 
             label = as.character(scales::percent(freq, accuracy = .1)))) +
  geom_col(position = 'stack') + 
  geom_text(position = position_stack(vjust = .5), vjust = 0.5, size = 2.5)  +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_viridis_d() +
  labs(title = "Indice de evaluación de insfraestructura y equipamiento barrial según macrozona",
       x = "", y = "", fill = "Nivel de evaluación",
       caption = fuente)
eval3_edad
```


## 4.4. Fortalezas y problemas de la comuna

## 4.5. Proyección 3 años